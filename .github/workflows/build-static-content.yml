name: æ„å»ºé™æ€å†…å®¹

on:
  # å½“ notes ç›®å½•ä¸‹çš„æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘
  push:
    paths:
      - 'notes/**'
      - 'scripts/build-static-content.js'
    branches:
      - main
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºæ‰€æœ‰å†…å®¹'
        required: false
        default: 'false'
        type: boolean

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# å¹¶å‘æ§åˆ¶ï¼Œç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªæ„å»ºåœ¨è¿è¡Œ
concurrency:
  group: "build-static-content"
  cancel-in-progress: true

jobs:
  build:
    name: æ„å»ºé™æ€å†…å®¹
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºæ£€æµ‹æ–‡ä»¶å˜æ›´
          fetch-depth: 0
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: æ£€æŸ¥ notes ç›®å½•
        id: check-notes
        run: |
          if [ -d "notes" ] && [ "$(ls -A notes)" ]; then
            echo "notes_exist=true" >> $GITHUB_OUTPUT
            echo "notes_count=$(find notes -name "*.md" | wc -l)" >> $GITHUB_OUTPUT
          else
            echo "notes_exist=false" >> $GITHUB_OUTPUT
            echo "notes_count=0" >> $GITHUB_OUTPUT
          fi
      
      - name: åˆ›å»ºç¤ºä¾‹å†…å®¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if: steps.check-notes.outputs.notes_exist == 'false'
        run: |
          echo "ğŸ“ notes ç›®å½•ä¸ºç©ºï¼Œæ„å»ºè„šæœ¬å°†åˆ›å»ºç¤ºä¾‹å†…å®¹"
      
      - name: æ„å»ºé™æ€å†…å®¹
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºé™æ€å†…å®¹..."
          echo "ğŸ“Š å‘ç° ${{ steps.check-notes.outputs.notes_count }} ä¸ªç¬”è®°æ–‡ä»¶"
          node scripts/build-static-content.js
      
      - name: éªŒè¯æ„å»ºè¾“å‡º
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºè¾“å‡º..."
          ls -la public/
          
          if [ -f "public/public-notes.json" ]; then
            echo "âœ… public-notes.json ç”ŸæˆæˆåŠŸ"
            echo "ğŸ“„ å…¬å¼€ç¬”è®°æ–‡ä»¶å¤§å°: $(du -h public/public-notes.json | cut -f1)"
          else
            echo "âŒ public-notes.json æœªç”Ÿæˆ"
            exit 1
          fi
          
          if [ -f "public/all-notes.json" ]; then
            echo "âœ… all-notes.json ç”ŸæˆæˆåŠŸ"
            echo "ğŸ“„ å®Œæ•´ç¬”è®°æ–‡ä»¶å¤§å°: $(du -h public/all-notes.json | cut -f1)"
          else
            echo "âŒ all-notes.json æœªç”Ÿæˆ"
            exit 1
          fi
          
          if [ -f "public/build-info.json" ]; then
            echo "âœ… build-info.json ç”ŸæˆæˆåŠŸ"
            echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
            cat public/build-info.json | jq '.'
          else
            echo "âŒ build-info.json æœªç”Ÿæˆ"
            exit 1
          fi
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: static-content
          path: |
            public/public-notes.json
            public/all-notes.json
            public/build-info.json
          retention-days: 30
      
      - name: æäº¤æ„å»ºç»“æœ
        run: |
          # é…ç½® git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet HEAD -- public/; then
            echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ„å»ºè¾“å‡ºçš„å˜æ›´"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ„å»ºè¾“å‡ºå˜æ›´ï¼Œæäº¤æ›´æ–°"
            git add public/public-notes.json public/all-notes.json public/build-info.json
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°é™æ€å†…å®¹ [skip ci]
            
            ğŸ“Š æ„å»ºç»Ÿè®¡:
            - æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            - ç¬”è®°æ•°é‡: ${{ steps.check-notes.outputs.notes_count }}
            - è§¦å‘æ–¹å¼: ${{ github.event_name }}
            
            ğŸ”— ç›¸å…³æäº¤: ${{ github.sha }}"
            
            git push
            echo "âœ… é™æ€å†…å®¹æ›´æ–°å®Œæˆ"
          fi
      
      - name: æ„å»ºçŠ¶æ€é€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ é™æ€å†…å®¹æ„å»ºæˆåŠŸå®Œæˆï¼"
            echo "ğŸ“Š å¤„ç†äº† ${{ steps.check-notes.outputs.notes_count }} ä¸ªç¬”è®°æ–‡ä»¶"
          else
            echo "âŒ é™æ€å†…å®¹æ„å»ºå¤±è´¥"
          fi

  # å¦‚æœå¯ç”¨äº† GitHub Pagesï¼Œå¯ä»¥è‡ªåŠ¨éƒ¨ç½²
  deploy-pages:
    name: éƒ¨ç½²åˆ° GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: æ„å»ºå‰ç«¯åº”ç”¨
        run: npm run build
      
      - name: ä¸‹è½½é™æ€å†…å®¹
        uses: actions/download-artifact@v4
        with:
          name: static-content
          path: dist/
      
      - name: è®¾ç½® Pages
        uses: actions/configure-pages@v4
      
      - name: ä¸Šä¼ åˆ° Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/
      
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
